# Changelog

All notable changes to this project will be documented in this file.

The format is based on [Keep a Changelog](https://keepachangelog.com/en/1.0.0/),
and this project adheres to [Semantic Versioning](https://semver.org/spec/v2.0.0.html).

## [3.0.0] - 2026-02-18

### Added

- Добавлена диагностика интеграции (diagnostics.py)
- Добавлен файл strings.json как источник переводов
- Добавлен шаг reconfigure для изменения пароля
- Добавлено сохранение и восстановление токенов авторизации
- Добавлено автоматическое удаление устаревших устройств

### Changed

- Обновлена библиотека aiotaipit до версии 3.0.0
- Использован паттерн runtime_data вместо hass.data[DOMAIN]
- Разделен декоратор на async_retry и async_api_request_handler
- Модернизирован config_flow: ConfigFlowResult, _get_reauth_entry()
- Удалён options flow (интервал обновления фиксирован — 30 минут)
- Убраны name= из описаний сенсоров (используется translation_key)
- Объединены mixin-классы в единые описания сущностей
- Добавлены аннотации Final ко всем константам
- Иконки сигнала перенесены из кода в icons.json (state-based icons)
- Удалён неиспользуемый exceptions.py

### Improved

- Улучшен алгоритм обновления: координатор вычисляет следующий слот передачи счётчика по часовой сетке (:00 и :30), учитывает дрейф часов счётчика (+3 мин) и опрашивает облако только после ожидаемого времени обновления
- Исправлен deprecated вызов dt.utcnow() → dt.now() в get_interval_to()

### Fixed

- Исправлена ошибка: ConfigEntryNotReady заменена на UpdateFailed при ошибках API после первичной настройки
- Исправлен translation_key для однофазного датчика тока (electric_current вместо electric_current_phase_1)
- Исправлена ошибка: сенсоры показывали состояние «unknown» после перезапуска HA — заменён _handle_coordinator_update на свойство native_value
- Удалён мёртвый код обработки исключений в координаторе (обрабатывается декоратором)

### Tests

- Добавлен полный набор тестов (81 тест): init, config_flow, coordinator, sensor, button, diagnostics, helpers, decorators


## [2.0.0] - 2025-04-06

### Added

- Добавлена поддержка трехфазных счетчиков, выводится информация по каждому из них электрический ток, напряжение и коэффициент мощности (cos φ).

## [1.5.0] - 2024-03-29

### Added

- Добававлен icons.json

## [1.4.1] - 2024-02-26

### Updated

- Изменен алгоритм расчета времени следующего обновления информации.


## [1.4.0] - 2024-02-26

### Added

- Используется asyncio.timeout вместо устаревшего пакета asyncio_timeout.
- Добавлена возможность изменения интервала обновления сенсоров.
- Добавлена возможность изменения логина и пароля без удаления интеграции.
- Обновлена библиотека aiotaipit до версии 2.2.0.

## [1.3.0] - 2023-04-22

### Added

- Добавлено автоматическое скрытие сенсоров для тарифов

## [1.2.1] - 2023-04-18

### Updated

- Рандомизировано время опроса облака в диапазоне от 2 до 5 минут и от 32 до 35 минут каждый час

## [1.2.0] - 2023-04-18

### Added

- Добавлен debouncer для вызовов API

### Fixed

- Небольшие исправления

## [1.1.0] - 2023-04-18

### Added

- Добавлена кнопка для немедленного обновления информации
- При вызове функций API при возникновении ошибки будет выполнено несколько попыток через определенный промежуток
  времени
- Добавлена поддержка переводов названий сенсоров
- Формирование уникального ID для сенсоров

### Changed

- Изменен расчет интервала обновления, теперь сенсоры опрашиваются не через 5 минут с пропусками, а время интервала
  задается точно после обновления сенсоров в облаке

## [1.0.0] - 2023-03-08

Первый публичный релиз.
